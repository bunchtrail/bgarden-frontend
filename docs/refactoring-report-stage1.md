# Отчет по этапу 1: Подготовка к рефакторингу сервисов регионов

## Выполненные действия
1. Создана ветка `refactor/region-services` для безопасного проведения рефакторинга
2. Проведен аудит импортов классов `RegionService` и `PolygonFactory`
3. Проанализирована существующая структура кода

## Результаты аудита

### Дублирование сервисов для работы с регионами

На данный момент в проекте используются 3 разных сервиса для работы с регионами:

1. **Основной сервис** (`src/services/regions/RegionService.ts`):
   - Содержит полный набор функций для работы с регионами
   - Используется другими сервисами через реэкспорт

2. **Сервис в модуле карты** (`src/modules/map/services/regionService.ts`):
   - Помечен как устаревший (@deprecated)
   - Реэкспортирует функции из основного сервиса
   - Используется компонентами карты

3. **Сервис в модуле образцов** (`src/modules/specimens/services/regionService.ts`):
   - Полностью дублирует функциональность основного сервиса
   - Имеет собственные реализации функций `getAllRegions`, `getDefaultRegions` и др.

### Дублирование фабрик для создания полигонов

1. **Основная фабрика** (`src/services/regions/PolygonFactory.ts`):
   - Содержит полный функционал для создания полигонов
   - Предоставляет стили, обработчики событий и другие настройки полигонов

2. **Устаревшая фабрика** (`src/services/MapPolygonFactory.ts`):
   - Помечена как устаревшая (@deprecated)
   - Просто наследуется от основной фабрики и реэкспортирует её

### Дублирование утилитарных функций

Функции для работы с координатами и регионами дублируются в:
1. `src/services/regions/RegionService.ts`
2. `src/utils/regionUtils.ts`

В особенности дублируются функции:
- `parseCoordinates`
- `getDefaultCoordinates`
- `convertPointsToPolygonCoordinates`
- `convertRegionsToAreas`

### Тесты

Не обнаружено специализированных тестов для сервисов регионов, что представляет риск при рефакторинге.

## Зависимости и импорты

### Импорты RegionService:
- `src/services/regionService.ts`
- `src/modules/specimens/services/specimenService.ts`
- `src/modules/specimens/index.ts`
- `src/modules/specimens/hooks/useReferenceData.ts`
- `src/modules/map/hooks/useMapData.ts`
- `src/modules/map/services/index.ts`
- `src/modules/map/services/regionService.ts`
- `src/modules/map/components/control-panel/UnifiedControlPanel.tsx`

### Импорты PolygonFactory:
- `src/services/MapPolygonFactory.ts`
- `src/modules/map/components/map-layers/MapDrawingLayer.tsx`
- `src/modules/map/components/map-components/MapRegionsLayer.tsx`

## Рекомендации для следующих этапов

1. **Создать новые тесты** перед значительными изменениями кода
2. **Консолидировать утилитарные функции** в модуле `utils/regionUtils.ts`
3. **Обновить основной сервис регионов** с функциональностью из модульных сервисов
4. **Добавить явные предупреждения о депрекации** к устаревшим модулям
5. **Обеспечить обратную совместимость** для плавного перехода

## Обновление: Этап 2 завершен (26.03.2025)

В рамках этапа 2 "Консолидация утилитарных функций" были выполнены следующие задачи:

1. **Создан новый файл `src/services/regions/RegionUtils.ts`**:
   - Перенесены все утилитарные функции из `src/utils/regionUtils.ts`
   - Сохранены все оригинальные сигнатуры функций
   - Добавлены необходимые комментарии

2. **Обновлен файл `src/services/regions/index.ts` для экспорта новых функций**:
   - Добавлены селективные экспорты уникальных функций
   - Обеспечена совместимость с существующими экспортами
   - Устранены конфликты именования с функциями из `RegionService.ts`

3. **Обеспечена обратная совместимость**:
   - Обновлен файл `src/utils/regionUtils.ts` с пометками об устаревании
   - Реэкспортированы все функции из нового местоположения
   - Добавлены комментарии `@deprecated` для всех экспортов

4. **Обновлены импорты в зависимых компонентах**:
   - Изменен импорт в `src/services/regions/PolygonFactory.ts` для использования локальных функций

5. **Проверка сборки**:
   - Проект успешно собирается без ошибок с помощью `npm run build`
   - Небольшие предупреждения, не связанные с рефакторингом, оставлены без изменений

## Проблемы и их решения

1. **Дублирование функций**: Некоторые функции (`parseCoordinates`, `getDefaultCoordinates`, и др.) были определены как в `RegionService.ts`, так и в `regionUtils.ts`. Решение:
   - Все функции сохранены в новом `RegionUtils.ts`
   - В `index.ts` добавлен выборочный экспорт только уникальных функций
   - Для остальных функций используются существующие определения из `RegionService.ts`

2. **Конфликты импортов**: При экспорте всех функций возникали конфликты. Решение:
   - Применен селективный экспорт только уникальных функций
   - Экспортирован полный модуль как `RegionUtils` для обратной совместимости

## Следующие шаги

1. Обновить оставшиеся импорты в других модулях для использования функций из `services/regions`
2. Продолжить объединение сервисов в рамках этапа 3 