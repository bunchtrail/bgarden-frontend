# Роадмап рефакторинга Botanical Garden App

## Выявленные проблемы

В ходе анализа кодовой базы приложения были выявлены следующие проблемы:

1. **Дублирование сервисов для работы с регионами:**
   - Основной сервис `src/services/regions/RegionService.ts`
   - Устаревший сервис в `src/modules/map/services/regionService.ts`
   - Ещё один сервис в `src/modules/specimens/services/regionService.ts`

2. **Дублирование функций преобразования регионов:**
   - `convertRegionsToAreas` в `src/services/regions/RegionService.ts`
   - Аналогичная функция в `src/utils/regionUtils.ts`

3. **Множественные фабрики для создания полигонов:**
   - Основная `PolygonFactory` в `src/services/regions/PolygonFactory.ts`
   - Устаревшая `MapPolygonFactory` в `src/services/MapPolygonFactory.ts`

4. **Дублирование утилитарных функций:**
   - `parseCoordinates` в разных модулях
   - `getDefaultCoordinates` в разных местах

## План рефакторинга

### Этап 1: Подготовка (1-2 дня)
- [x] Создать ветку `refactor/region-services`
- [x] Провести полный аудит импортов классов `RegionService` и `PolygonFactory`
- [x] Убедиться, что тесты покрывают все критические функции
- [x] Задокументировать результаты в `docs/refactoring-report-stage1.md`

### Этап 2: Консолидация утилитарных функций (2-3 дня)
- [ ] Перенести все утилитарные функции из `regionUtils.ts` в унифицированный модуль `services/regions`
- [ ] Обеспечить обратную совместимость через реэкспорты
- [ ] Создать единую точку входа для всех функций через `index.ts`

### Этап 3: Объединение сервисов (3-4 дня)
- [ ] Расширить основной `RegionService` функциональностью из модульных сервисов
- [ ] Создать новые типы и интерфейсы для универсальной работы с регионами
- [ ] Обновить зависимости во всех компонентах, использующих сервисы регионов

### Этап 4: Унификация фабрик (2-3 дня)
- [ ] Доработать `PolygonFactory` всеми необходимыми методами
- [ ] Удалить `MapPolygonFactory` после переноса всех функций
- [ ] Обновить импорты во всех компонентах, использующих фабрики

### Этап 5: Очистка кода (1-2 дня)
- [ ] Удалить устаревшие файлы и модули после успешного тестирования
- [ ] Добавить предупреждения о депрекации (`@deprecated`) к реэкспортам
- [ ] Проверить возможные регрессии и производительность

### Этап 6: Тестирование и документация (2-3 дня)
- [ ] Провести полное тестирование модуля карты
- [ ] Обновить документацию по модулям
- [ ] Создать схему зависимостей для обновлённой структуры

## Приоритетные задачи

1. **Высокий приоритет:**
   - Унификация `PolygonFactory` и `RegionService`
   - Исправление функции `convertRegionsToAreas`

2. **Средний приоритет:**
   - Удаление устаревших сервисов
   - Рефакторинг компонента `MapRegionsLayer`

3. **Низкий приоритет:**
   - Улучшение типизации
   - Оптимизация производительности рендеринга регионов

## Технические примечания

- Использовать абсолютные импорты (`@/services/regions`)
- Следовать правилам модульной структуры
- Обеспечить обратную совместимость на переходном этапе
- Обновлять тесты параллельно с изменениями в коде

## Ожидаемые результаты

После завершения рефакторинга:
1. Единый модуль `services/regions` для всей логики работы с регионами
2. Отсутствие дублирования кода
3. Улучшенная поддержка и расширяемость
4. Упрощённая структура зависимостей

## Текущий статус
- Завершен этап 1 (25.03.2025): создана ветка, проведен аудит импортов, подготовлен отчет
- Следующий этап: консолидация утилитарных функций
